name: Testes E2E Cypress (Docker)

on:
    workflow_dispatch:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    e2e-docker:
        runs-on: ubuntu-22.04

        env:
            CYPRESS_BASE_URL: ${{ secrets.CYPRESS_BASE_URL }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Subir ambiente E2E (Docker Compose)
              run: docker compose -f docker-compose-e2e.yml up -d

            - name: Aguardar servi√ßos ficarem prontos
              run: sleep 20

            - name: Rodar testes E2E
              run: docker compose -f docker-compose-e2e.yml up --exit-code-from cypress_test_blog_e2e

            - name: Derrubar containers
              if: always()
              run: docker compose -f docker-compose-e2e.yml down

            - name: Salvar screenshots
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: cypress-screenshots
                  path: cypress/screenshots
